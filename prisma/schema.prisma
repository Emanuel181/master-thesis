generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String                  @id @default(cuid())
  name                String?
  email               String?                 @unique
  image               String?
  emailVerified       DateTime?
  firstName           String?
  lastName            String?
  phone               String?
  jobTitle            String?
  company             String?
  bio                 String?
  location            String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  // Warning tracking
  warningCount        Int                     @default(0)
  lastWarningAt       DateTime?
  // GDPR Compliance Fields
  gdprConsentAt       DateTime? // When user gave GDPR consent
  marketingConsent    Boolean                 @default(false) // Explicit marketing opt-in
  dataExportedAt      DateTime? // Last data export request (for audit)
  deletionRequestedAt DateTime? // Soft delete request timestamp
  accounts            Account[]
  useCases            KnowledgeBaseCategory[]
  prompts             Prompt[]
  sessions            Session[]
  auditLogs           AuditLog[]
  warnings            UserWarning[]
  savedArticles       SavedArticle[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String?
  provider          String
  providerAccountId String
  access_token      String?
  expires_at        Int?
  id_token          String?
  refresh_token     String?
  scope             String?
  session_state     String?
  token_type        String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Globally banned emails
model BannedEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String?
  bannedBy  String // Admin email who banned
  createdAt DateTime @default(now())
}

// Globally banned IPs
model BannedIP {
  id        String   @id @default(cuid())
  ip        String   @unique
  reason    String?
  bannedBy  String // Admin email who banned
  createdAt DateTime @default(now())
}

// User warnings - track warned users by email
model UserWarning {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason    String
  warnedBy  String // Admin email who warned
  createdAt DateTime @default(now())

  @@index([userId])
}

model KnowledgeBaseCategory {
  id        String        @id @default(cuid())
  title     String
  content   String
  icon      String        @default("File")
  color     String        @default("default")
  userId    String
  groupId   String? // Optional: which group this use case belongs to
  order     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  folders   Folder[]
  user      User          @relation(fields: [userId], references: [id])
  group     UseCaseGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  pdfs      Pdf[]

  @@index([groupId])
}

// Groups/Folders for organizing use cases
model UseCaseGroup {
  id        String                  @id @default(cuid())
  name      String
  icon      String                  @default("Folder")
  color     String                  @default("default")
  order     Int                     @default(0)
  userId    String
  parentId  String? // For nested groups
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  useCases  KnowledgeBaseCategory[]
  parent    UseCaseGroup?           @relation("GroupToGroup", fields: [parentId], references: [id], onDelete: Cascade)
  children  UseCaseGroup[]          @relation("GroupToGroup")

  @@index([userId])
  @@index([parentId])
}

model RateLimit {
  key       String   @id
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt]) // For cleanup job efficiency
}

// GDPR Audit Log - tracks data access and modifications for compliance
model AuditLog {
  id         String   @id @default(cuid())
  userId     String? // Nullable for system events or deleted users
  action     String // e.g., "login", "data_export", "profile_update", "data_delete"
  resource   String? // e.g., "user", "use_case", "prompt"
  resourceId String? // ID of the affected resource
  ipAddress  String? // Anonymized/hashed for GDPR (last octet zeroed)
  userAgent  String? // Browser/client info (truncated)
  metadata   String? // JSON string for additional context (no PII)
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt]) // Composite index for user activity queries (e.g., "show my last 50 actions")
}

model Folder {
  id        String                @id @default(cuid())
  name      String
  order     Int                   @default(0)
  useCaseId String
  parentId  String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  parent    Folder?               @relation("FolderToFolder", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[]              @relation("FolderToFolder")
  useCase   KnowledgeBaseCategory @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  pdfs      Pdf[]

  @@index([useCaseId])
  @@index([parentId])
}

model Pdf {
  id                String                @id @default(cuid())
  url               String
  title             String
  size              Int
  s3Key             String
  order             Int                   @default(0)
  useCaseId         String
  folderId          String?
  createdAt         DateTime              @default(now())
  // RAG-specific fields
  vectorized        Boolean               @default(false) // Whether document has been vectorized
  vectorizedAt      DateTime? // When vectorization completed
  bedrockDataSourceId String? // Bedrock data source ID
  embeddingStatus   String                @default("pending") // pending, processing, completed, failed
  chunkCount        Int                   @default(0) // Number of chunks created
  folder            Folder?               @relation(fields: [folderId], references: [id])
  useCase           KnowledgeBaseCategory @relation(fields: [useCaseId], references: [id], onDelete: Cascade)

  @@index([useCaseId])
  @@index([folderId])
  @@index([vectorized])
  @@index([embeddingStatus])
}

model Prompt {
  id        String   @id @default(cuid())
  agent     String
  title     String   @default("Untitled")
  text      String
  s3Key     String
  order     Int      @default(0)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // For user's prompts sorted by date
}

// Distributed Circuit Breaker state (shared across ECS Fargate tasks)
model CircuitBreaker {
  name            String    @id // Unique circuit name (e.g., 'github-api')
  state           String    @default("CLOSED") // CLOSED, OPEN, HALF_OPEN
  failureCount    Int       @default(0)
  successCount    Int       @default(0)
  lastFailureAt   DateTime?
  lastStateChange DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([state])
}

// Project Supporters - people who contributed to the project
model Supporter {
  id              String   @id @default(cuid())
  name            String
  avatarUrl       String?
  occupation      String
  company         String?
  companyUrl      String? // Link to company website
  contributionBio String // What they helped with
  personalBio     String? // Short bio about the person
  linkedinUrl     String?
  websiteUrl      String?
  tier            String   @default("supporter") // sponsor, contributor, supporter
  featured        Boolean  @default(false)
  order           Int      @default(0)
  visible         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tier])
  @@index([visible])
  @@index([order])
}

// User-submitted articles for the blog
model Article {
  id                     String            @id @default(cuid())
  title                  String
  slug                   String            @unique
  contentJson            Json? // TipTap JSON - source of truth for editor
  contentMarkdown        String?           @db.Text // Derived markdown for search/AI/export
  content                String            @db.Text // Legacy field - kept for backward compat
  contentS3Key           String? // S3 key for content (if using S3 storage)
  excerpt                String // Short description
  category               String
  iconName               String            @default("Shield") // Icon for the article card
  iconPosition           String            @default("center") // Icon position: top-left, top-center, top-right, center-left, center, center-right, bottom-left, bottom-center, bottom-right
  iconColor              String            @default("white") // Icon color: white, black, red, orange, amber, yellow, lime, green, emerald, teal, cyan, sky, blue, indigo, violet, purple, fuchsia, pink, rose
  gradient               String? // Optional gradient for card background
  coverImage             String? // Optional cover image URL (S3 or external)
  coverType              String            @default("gradient") // "gradient" or "image"
  authorId               String
  authorName             String // Cached author name for display
  authorEmail            String // Cached author email
  status                 String            @default("DRAFT") // DRAFT, PENDING_REVIEW, IN_REVIEW, PUBLISHED, REJECTED, SCHEDULED_FOR_DELETION
  adminFeedback          String? // Feedback from admin if rejected or approved with notes
  readTime               String? // e.g., "5 min read"
  featured               Boolean           @default(false) // Is this the main featured article on the blog?
  showInMoreArticles     Boolean           @default(true) // Show this in the "More articles" section
  featuredOrder          Int               @default(0) // Order for featured articles (lower = higher priority)
  submittedAt            DateTime?
  reviewedAt             DateTime?
  publishedAt            DateTime?
  rejectedAt             DateTime? // When the article was rejected
  scheduledForDeletionAt DateTime? // When the article is scheduled to be deleted (3 days after rejection)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  reactions              ArticleReaction[]
  media                  ArticleMedia[]
  savedBy                SavedArticle[]

  @@index([status])
  @@index([authorId])
  @@index([status, submittedAt])
  @@index([slug])
  @@index([scheduledForDeletionAt])
  @@index([featured])
}

// Media files associated with articles (stored in S3)
model ArticleMedia {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  type      String // "image", "video", "audio", "file"
  fileName  String // Original file name
  fileSize  Int // File size in bytes
  mimeType  String // MIME type (e.g., "image/png", "video/mp4")
  s3Key     String // S3 object key
  url       String? // Cached URL or placeholder URL used in content
  width     Int? // For images/videos - original width
  height    Int? // For images/videos - original height
  duration  Int? // For audio/video - duration in seconds
  caption   String? // Optional caption
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([articleId])
  @@index([s3Key])
}

// Article reactions (likes, etc.)
model ArticleReaction {
  id        String   @id @default(cuid())
  articleId String
  userId    String
  type      String   @default("like") // like, love, insightful, etc.
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId]) // One reaction per user per article
  @@index([articleId])
  @@index([userId])
}

// Saved articles for users
model SavedArticle {
  id        String   @id @default(cuid())
  articleId String
  userId    String
  createdAt DateTime @default(now())
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId]) // One save per user per article
  @@index([articleId])
  @@index([userId])
}

// User notifications
model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String // ARTICLE_APPROVED, ARTICLE_REJECTED, etc.
  title     String
  message   String
  link      String? // Optional link to navigate to
  read      Boolean   @default(false)
  readAt    DateTime?
  metadata  String? // JSON string for additional data
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

// Admin Account - Stores admin users with email/password authentication
model AdminAccount {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String?   // bcrypt hashed password (null until email verified)
  emailVerified       Boolean   @default(false)
  verificationToken   String?   @unique // Token for email verification
  verificationExpires DateTime? // Token expiry
  isMasterAdmin       Boolean   @default(false) // True for the master admin
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  lastLoginAt         DateTime?

  @@index([email])
  @@index([verificationToken])
}

// Admin Passkey - WebAuthn credentials for admin authentication
model AdminPasskey {
  id              String   @id @default(cuid())
  email           String // Admin email this passkey belongs to
  credentialId    String   @unique // Base64URL encoded credential ID
  publicKey       Bytes // COSE public key bytes
  webauthnUserId  String // Base64URL encoded user handle for WebAuthn
  counter         BigInt   @default(0) // Signature counter for replay attack prevention
  deviceType      String // 'singleDevice' or 'multiDevice'
  backedUp        Boolean  @default(false) // Whether passkey is backed up
  transports      String? // Comma-separated list of transports (usb, ble, nfc, internal, etc.)
  aaguid          String? // Authenticator Attestation GUID
  deviceName      String? // Optional user-friendly device name
  lastUsedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([credentialId])
}

// Admin Passkey Challenge - Temporary storage for WebAuthn challenges
model AdminPasskeyChallenge {
  id        String   @id @default(cuid())
  email     String
  challenge String // Base64URL encoded challenge
  type      String // 'registration' or 'authentication'
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

// Workflow Run - Tracks execution of agentic workflows
model WorkflowRun {
  id                String              @id @default(cuid())
  userId            String
  status            String              @default("pending") // pending, running, completed, failed
  startedAt         DateTime            @default(now())
  completedAt       DateTime?
  totalUseCases     Int                 @default(0)
  completedUseCases Int                 @default(0)
  metadata          Json?               // Stores code, codeType, and other workflow metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  vulnerabilities   Vulnerability[]
  useCaseRuns       WorkflowUseCaseRun[]

  @@index([userId])
  @@index([status])
  @@index([startedAt])
}

// Workflow Use Case Run - Tracks individual use case execution within a workflow
model WorkflowUseCaseRun {
  id                  String       @id @default(cuid())
  workflowRunId       String
  useCaseId           String
  useCaseTitle        String
  status              String       @default("pending") // pending, running, completed, failed
  reviewerCompleted   Boolean      @default(false)
  implementerCompleted Boolean     @default(false)
  testerCompleted     Boolean      @default(false)
  reporterCompleted   Boolean      @default(false)
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  workflowRun         WorkflowRun  @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)

  @@index([workflowRunId])
  @@index([useCaseId])
  @@index([status])
}

// Vulnerability - Stores detected vulnerabilities from code analysis
model Vulnerability {
  id                String       @id @default(cuid())
  workflowRunId     String
  useCaseId         String
  severity          String // Critical, High, Medium, Low
  title             String
  type              String // Security, Performance, Best Practice
  details           String       @db.Text
  fileName          String
  // Detailed analysis fields
  vulnerableCode    String?      @db.Text
  explanation       String?      @db.Text
  bestPractices     String?      @db.Text
  exploitExamples   String?      @db.Text
  attackPath        String?      @db.Text
  cweId             String? // CWE identifier
  // Metadata
  lineNumber        Int?
  columnNumber      Int?
  confidence        Float        @default(1.0) // 0.0 to 1.0
  falsePositive     Boolean      @default(false)
  resolved          Boolean      @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  workflowRun       WorkflowRun  @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)
  fixes             CodeFix[]

  @@index([workflowRunId])
  @@index([useCaseId])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

// Code Fix - Stores automated fixes for vulnerabilities
model CodeFix {
  id                String        @id @default(cuid())
  vulnerabilityId   String
  vulnerability     Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  
  // Original code
  fileName          String
  originalCode      String        @db.Text
  startLine         Int?
  endLine           Int?
  language          String?
  
  // Fixed code
  fixedCode         String        @db.Text
  changes           Json          // Detailed line-by-line changes
  
  // Fix metadata
  explanation       String        @db.Text
  confidence        Float         @default(1.0)
  
  // Status
  status            FixStatus     @default(PENDING)
  reviewedAt        DateTime?
  reviewedBy        String?
  
  // PR info
  prUrl             String?
  prNumber          Int?
  branchName        String?
  commitSha         String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([vulnerabilityId])
  @@index([status])
  @@index([fileName])
}

enum FixStatus {
  PENDING
  ACCEPTED
  REJECTED
  APPLIED
  PR_CREATED
}

// Agent Configuration - Stores custom prompts and settings for each agent
model AgentConfiguration {
  id              String   @id @default(cuid())
  userId          String
  agentType       String // reviewer, implementer, tester, reporter
  modelId         String? // Bedrock model ID
  customPrompt    String?  @db.Text
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, agentType])
  @@index([userId])
  @@index([agentType])
}
