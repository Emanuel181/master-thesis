generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String                  @id @default(cuid())
  name                String?
  email               String?                 @unique
  image               String?
  emailVerified       DateTime?
  firstName           String?
  lastName            String?
  phone               String?
  jobTitle            String?
  company             String?
  bio                 String?
  location            String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  // GDPR Compliance Fields
  gdprConsentAt       DateTime? // When user gave GDPR consent
  marketingConsent    Boolean                 @default(false) // Explicit marketing opt-in
  dataExportedAt      DateTime? // Last data export request (for audit)
  deletionRequestedAt DateTime? // Soft delete request timestamp
  accounts            Account[]
  useCases            KnowledgeBaseCategory[]
  prompts             Prompt[]
  sessions            Session[]
  auditLogs           AuditLog[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String?
  provider          String
  providerAccountId String
  access_token      String?
  expires_at        Int?
  id_token          String?
  refresh_token     String?
  scope             String?
  session_state     String?
  token_type        String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model KnowledgeBaseCategory {
  id        String        @id @default(cuid())
  title     String
  content   String
  icon      String        @default("File")
  color     String        @default("default")
  userId    String
  groupId   String? // Optional: which group this use case belongs to
  order     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  folders   Folder[]
  user      User          @relation(fields: [userId], references: [id])
  group     UseCaseGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  pdfs      Pdf[]

  @@index([groupId])
}

// Groups/Folders for organizing use cases
model UseCaseGroup {
  id        String                  @id @default(cuid())
  name      String
  icon      String                  @default("Folder")
  color     String                  @default("default")
  order     Int                     @default(0)
  userId    String
  parentId  String? // For nested groups
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  useCases  KnowledgeBaseCategory[]
  parent    UseCaseGroup?           @relation("GroupToGroup", fields: [parentId], references: [id], onDelete: Cascade)
  children  UseCaseGroup[]          @relation("GroupToGroup")

  @@index([userId])
  @@index([parentId])
}

model RateLimit {
  key       String   @id
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt]) // For cleanup job efficiency
}

// GDPR Audit Log - tracks data access and modifications for compliance
model AuditLog {
  id         String   @id @default(cuid())
  userId     String? // Nullable for system events or deleted users
  action     String // e.g., "login", "data_export", "profile_update", "data_delete"
  resource   String? // e.g., "user", "use_case", "prompt"
  resourceId String? // ID of the affected resource
  ipAddress  String? // Anonymized/hashed for GDPR (last octet zeroed)
  userAgent  String? // Browser/client info (truncated)
  metadata   String? // JSON string for additional context (no PII)
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt]) // Composite index for user activity queries (e.g., "show my last 50 actions")
}

model Folder {
  id        String                @id @default(cuid())
  name      String
  order     Int                   @default(0)
  useCaseId String
  parentId  String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  parent    Folder?               @relation("FolderToFolder", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[]              @relation("FolderToFolder")
  useCase   KnowledgeBaseCategory @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  pdfs      Pdf[]

  @@index([useCaseId])
  @@index([parentId])
}

model Pdf {
  id        String                @id @default(cuid())
  url       String
  title     String
  size      Int
  s3Key     String
  order     Int                   @default(0)
  useCaseId String
  folderId  String?
  createdAt DateTime              @default(now())
  folder    Folder?               @relation(fields: [folderId], references: [id])
  useCase   KnowledgeBaseCategory @relation(fields: [useCaseId], references: [id], onDelete: Cascade)

  @@index([useCaseId])
  @@index([folderId])
}

model Prompt {
  id        String   @id @default(cuid())
  agent     String
  title     String   @default("Untitled")
  text      String
  s3Key     String
  order     Int      @default(0)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // For user's prompts sorted by date
}

// Distributed Circuit Breaker state (shared across ECS Fargate tasks)
model CircuitBreaker {
  name            String    @id // Unique circuit name (e.g., 'github-api')
  state           String    @default("CLOSED") // CLOSED, OPEN, HALF_OPEN
  failureCount    Int       @default(0)
  successCount    Int       @default(0)
  lastFailureAt   DateTime?
  lastStateChange DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([state])
}

// Project Supporters - people who contributed to the project
model Supporter {
  id              String   @id @default(cuid())
  name            String
  avatarUrl       String?
  occupation      String
  company         String?
  contributionBio String // What they helped with
  personalBio     String? // Short bio about the person
  linkedinUrl     String?
  websiteUrl      String?
  tier            String   @default("supporter") // sponsor, contributor, supporter
  featured        Boolean  @default(false)
  order           Int      @default(0)
  visible         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tier])
  @@index([visible])
  @@index([order])
}
